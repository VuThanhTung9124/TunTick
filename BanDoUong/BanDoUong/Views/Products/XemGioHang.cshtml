@model List<BanDoUong.Models.CartItem>

<h2 class="text-xl font-bold mb-4">Giỏ hàng của bạn</h2>


<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - ToCoToCo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to bottom right, #fffdf7, #fdf2d9);
        }

        .card {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            transition: transform .3s ease;
        }

        .btn-main {
            background: linear-gradient(90deg, #f59e0b, #eab308);
            color: #fff;
            font-weight: 600;
            transition: all .3s ease;
        }

            .btn-main:hover {
                opacity: 0.9;
                transform: translateY(-2px);
            }
    </style>
</head>
<body class="text-gray-800">

    <div class="flex justify-between items-center mb-6">
        @Html.ActionLink("⬅️ Quay lại trang chủ", "Index", "Products", null, new { @class = "text-sm text-amber-600 hover:underline" })
    </div>


    <!-- Main -->
    <main class="max-w-6xl mx-auto my-10 p-6 card">
        <h1 class="text-3xl font-bold text-amber-700 mb-6 text-center">Giỏ hàng của bạn</h1>

        <div class="overflow-x-auto">
            @if (Model.Count == 0)
            {
                <p class="text-center text-gray-500 italic py-8">Giỏ hàng trống.</p>
            }
            else
            {
                <form id="cartForm">
                    <table class="min-w-full border-collapse">
                        <thead>
                            <tr class="bg-amber-50 text-amber-800 text-left text-sm uppercase">
                                <th class="p-2 text-center">
                                    <input type="checkbox" id="selectAll" class="accent-amber-500 w-4 h-4" />
                                </th>
                                <th class="p-2">Ảnh</th>
                                <th class="p-2">Tên</th>
                                <th class="p-2">Giá</th>
                                <th class="p-2">Số lượng</th>
                                <th class="p-2">Thành tiền</th>
                                <th class="p-2 text-center">Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="cartBody" class="divide-y divide-gray-200">
                            @foreach (var item in Model)
                            {
                                <tr class="hover:bg-amber-50 transition" data-id="@item.ProductId">
                                    <!-- Checkbox chọn sản phẩm -->
                                    <td class="p-3 text-center">
                                        <input type="checkbox" class="product-check accent-amber-500 w-4 h-4"
                                               data-price="@(item.Price * item.Quantity)" />
                                    </td>

                                    <!-- Ảnh + tên -->
                                    <td class="p-3">
                                        <img src="@Url.Content("~/Image_Water/" + item.Thumbnail)"
                                             alt="@item.Name"
                                             class="h-16 w-16 rounded-lg object-cover shadow-sm inline-block" />
                                    </td>
                                    <td class="p-3 font-medium">@item.Name</td>

                                    <!-- Giá -->
                                    <td class="p-3 text-amber-600 font-medium">@item.Price.ToString("N0")₫</td>

                                    <!-- Số lượng -->
                                    <td class="p-3">
                                        <input type="number"
                                               value="@item.Quantity"
                                               min="1"
                                               data-id="@item.ProductId"
                                               class="quantity-input border border-gray-300 rounded-md w-20 px-2 py-1 text-center"
                                               onchange="CapNhatSoLuong(this)" />

                                    </td>

                                    <!-- Thành tiền -->
                                    <td class="p-3 font-semibold text-amber-700">
                                        <span class="itemTotal">@((item.Price * item.Quantity).ToString("N0"))₫</span>
                                    </td>

                                    <!-- Nút xóa -->
                                    <td class="p-3 text-center">
                                        <button type="button" onclick="removeItem(this)"
                                                class="text-red-500 hover:text-red-700 text-sm font-medium">
                                            Xóa
                                        </button>
                                    </td>
                                </tr>
                            }

                        </tbody>
                    </table>

                    <!-- Nút Thanh toán -->
                    <div class="flex justify-between items-center mt-6 border-t pt-4">
                        <div class="text-gray-700 text-lg">
                            Tổng tiền:
                            <span id="tongCong" class="font-bold text-amber-700 text-xl ml-2">0₫</span>
                        </div>
                        <button type="button"
                                id="btnThanhToan"
                                onclick="thanhToan()"
                                class="btn-main rounded-full px-6 py-2 text-lg disabled:opacity-40 disabled:cursor-not-allowed"
                                disabled>
                            Thanh Toán
                        </button>
                    </div>

                </form>
            }
        </div>
    </main>


    @section scripts {
        <script>
    document.addEventListener("DOMContentLoaded", function () {
        const selectAll = document.getElementById("selectAll");
        const checks = document.querySelectorAll(".product-check");
        const btnThanhToan = document.getElementById("btnThanhToan");
        const tongEl = document.getElementById("tongCong");

        // Gán sự kiện cho checkbox "chọn tất cả"
        if (selectAll) {
            selectAll.addEventListener("change", function () {
                checks.forEach(cb => cb.checked = this.checked);
                tinhTong();
            });
        }

        // Gán sự kiện cho từng checkbox sản phẩm
        checks.forEach(cb => cb.addEventListener("change", tinhTong));

        // Hàm tính tổng tiền và bật/tắt nút thanh toán
        function tinhTong() {
            let tong = 0;
            document.querySelectorAll(".product-check:checked").forEach(cb => {
                tong += parseFloat(cb.dataset.price);
            });
            tongEl.textContent = tong.toLocaleString('vi-VN') + "₫";
            btnThanhToan.disabled = tong === 0;
        }

        // Cập nhật thành tiền khi thay đổi số lượng
        window.updateTotal = function () {
            const rows = document.querySelectorAll("#cartBody tr");
            rows.forEach(row => {
                const priceText = row.querySelector("td:nth-child(4)").innerText.replace(/[₫,]/g, '').trim();
                const price = parseFloat(priceText) || 0;
                const qty = parseInt(row.querySelector(".quantity-input").value) || 1;
                const itemTotal = price * qty;
                row.querySelector(".itemTotal").innerText = itemTotal.toLocaleString('vi-VN') + "₫";
                row.querySelector(".product-check").dataset.price = itemTotal;
            });
            tinhTong();
        };

        // Xóa 1 sản phẩm
        window.removeItem = function (btn) {
            const row = btn.closest("tr");
            if (!row) return;
            row.remove();
            updateTotal();
        };

        // Gọi tính tổng khi tải xong trang
        updateTotal();
    });

    // 👉 Hàm Thanh toán (chuyển trang)
    function thanhToan() {
        const selectedIds = [];
        document.querySelectorAll(".product-check:checked").forEach(cb => {
            const row = cb.closest("tr");
            selectedIds.push(row.dataset.id);
        });

        if (selectedIds.length === 0) {
            alert("Vui lòng chọn ít nhất 1 sản phẩm để thanh toán!");
            return;
        }

        // Gửi danh sách ID sản phẩm qua query string
        const url = '@Url.Action("ThanhToan", "Products")' + '?ids=' + selectedIds.join(',');
        window.location.href = url;
    }

    // Gán sự kiện click cho nút
    document.addEventListener("DOMContentLoaded", function () {
        const btnThanhToan = document.getElementById("btnThanhToan");
        if (btnThanhToan) {
            btnThanhToan.addEventListener("click", thanhToan);
        }
    });

            //Cập nhật số lượng sản phẩm 
            window.CapNhatSoLuong = function (input) {
    const row = input.closest("tr");
    const productId = row.dataset.id;
    const newQty = parseInt(input.value) || 1;

    // Cập nhật lại thành tiền trên giao diện
    const priceText = row.querySelector("td:nth-child(4)").innerText.replace(/[₫,]/g, '').trim();
    const price = parseFloat(priceText);
    const total = price * newQty;
    row.querySelector(".itemTotal").innerText = total.toLocaleString('vi-VN') + "₫";
    row.querySelector(".product-check").dataset.price = total;
    updateTotal();

    // Gửi AJAX cập nhật lên server
    fetch('@Url.Action("CapNhatSoLuong", "Products")', {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
        },
        body: JSON.stringify({ productId: productId, quantity: newQty })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) alert("Cập nhật số lượng thất bại!");
    })
    .catch(() => alert("Lỗi kết nối khi cập nhật số lượng."));
};

        </script>
    }


</body>
</html>
